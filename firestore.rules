rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ADMIN ACCESS
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'kumaresans407@gmail.com';
    }

    // allow admin to do anything
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // USERS
    // - Anyone authenticated can read users
    // - Anyone authenticated can update users (Required for the 'Accept Invite' flow where User A updates User B's coupleId)
    //   Note: In a production app, this should be stricter (e.g., only allow updating 'coupleId'), but for this prototype, we'll allow it to ensure functionality.
    match /users/{userId} {
      allow read, update: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow creation if needed (e.g. initial sign up)
    }

    // FRIEND REQUESTS
    match /requests/{requestId} {
      // Allow any auth user to create a request (simplified for debugging)
      allow create: if isAuthenticated();
      // Allow read/delete if you are involved
      allow read, delete: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid || 
        resource.data.toUserId == request.auth.uid
      );
    }

    // COUPLES
    // - Create: If you are one of the users in the couple
    // - Read/Update: If you are one of the users in the couple
    match /couples/{coupleId} {
      function isMemberOfCouple() {
        return isAuthenticated() && (
          resource.data.user1Id == request.auth.uid || 
          resource.data.user2Id == request.auth.uid
        );
      }
      
      // When creating, we check the incoming data (request.resource)
      allow create: if isAuthenticated() && (
        request.resource.data.user1Id == request.auth.uid || 
        request.resource.data.user2Id == request.auth.uid
      );
      
      // Allow any authenticated user to read couple data (needed to check if potential partner is already connected)
      allow read: if isAuthenticated();
      // Only members can update
      allow update: if isMemberOfCouple();

      // SUBCOLLECTIONS: Snacks & Spins
      // Allow access if the user is a member of the parent couple
      match /snacks/{snackId} {
        allow read, write: if get(/databases/$(database)/documents/couples/$(coupleId)).data.user1Id == request.auth.uid ||
                             get(/databases/$(database)/documents/couples/$(coupleId)).data.user2Id == request.auth.uid;
      }

      match /spins/{spinId} {
        allow read, write: if get(/databases/$(database)/documents/couples/$(coupleId)).data.user1Id == request.auth.uid ||
                             get(/databases/$(database)/documents/couples/$(coupleId)).data.user2Id == request.auth.uid;
      }
    }
  }
}
